<%- include ../partials/header.ejs %>

<div class="interior-page" id="update-ticket-admin">
    <section>
        <div class="container">
            <form method="post" action="/incident/update/<%= ticket._id %>">
                <%if(ticket.status == 'Closed') { %>
                <h2>This ticket has been closed</h2>
                <h2>It cannot be updated</h2>
                <% } else { %>
                <h2><%= title %></h2>
                <% } %>
                <fieldset class="form-group">
                    <label for="username">Ticket Owner</label>
                    <input type="text" class="form-control" id="username" name="username" value="<%= ticket.username %>" readonly>
                </fieldset>
                <fieldset class="form-group">
                    <label for="title">Title</label>
                    <input type="text" class="form-control" id="title" name="title" value="<%= ticket.title %>" required>
                </fieldset>
                <fieldset class="form-group">
                    <label for="description">Description</label>
                    <textarea class="form-control" id="description" name="description" placeholder="description"
                            required><%= ticket.description %></textarea>
                </fieldset>
                <fieldset class="form-group">
                    <label for="severity">Severity</label>
                    <input type="text" class="form-control" id="severity" name="severity"
                        value="<% if (ticket.severity <= 15) { %>Green
                                <% } else if(ticket.severity >= 16 && ticket.severity <= 30) { %>Yellow
                                <% } else if (ticket.severity >= 31 && ticket.severity <= 45) { %>Red
                                <% } %>" readonly>
                </fieldset>
                <fieldset class="form-group">
                    <label for="status">Status</label>
                    <select class="form-control" id="status" name="status">
                        <% if(ticket.status == 'Open' ) { %>
                        <option value="Open" selected>Open</option>
                        <% } else { %>
                        <option value="Open">Open</option>
                        <% } %>
    
                        <% if(ticket.status == 'Assigned' ) { %>
                        <option value="Assigned" selected>Assigned</option>
                        <% } else { %>
                        <option value="Assigned">Assigned</option>
                        <% } %>
    
                        <% if(ticket.status == 'In Progress' ) { %>
                        <option value="In Progress" selected>In Progress</option>
                        <% } else { %>
                        <option value="In Progress">In Progress</option>
                        <% } %>
    
                        <% if(ticket.status == 'Pending' ) { %>
                        <option value="Pending" selected>Pending</option>
                        <% } else { %>
                        <option value="Pending">Pending</option>
                        <% } %>
    
                        <% if(ticket.status == 'Resolved' ) { %>
                        <option value="Resolved" selected>Resolved</option>
                        <% } else { %>
                        <option value="Resolved">Resolved</option>
                        <% } %>
    
                        <% if(ticket.status == 'Closed' ) { %>
                        <option value="Closed" selected>Closed</option>
                        <% } else { %>
                        <option value="Closed">Closed</option>
                        <% } %>
                    </select>
                </fieldset>
                <fieldset class="form-group">
                    <label for="priority">Priority</label>
                    <select class="form-control" id="priority" name="priority">
                        <% if(ticket.priority == 1 ) { %>
                        <option value="1" selected>1 (Low)</option>
                        <% } else { %>
                        <option value="1">1</option>
                        <% } %>
    
                        <% if(ticket.priority == 2 ) { %>
                        <option value="2" selected>2</option>
                        <% } else { %>
                        <option value="2">2</option>
                        <% } %>
    
                        <% if(ticket.priority == 3 ) { %>
                        <option value="3" selected>3</option>
                        <% } else { %>
                        <option value="3">3</option>
                        <% } %>
    
                        <% if(ticket.priority == 4 ) { %>
                        <option value="4" selected>4</option>
                        <% } else { %>
                        <option value="4">4</option>
                        <% } %>
    
                        <% if(ticket.priority == 5 ) { %>
                        <option value="5" selected>5</option>
                        <% } else { %>
                        <option value="5">5</option>
                        <% } %>
    
                        <% if(ticket.priority == 6 ) { %>
                        <option value="6" selected>6 (High)</option>
                        <% } else { %>
                        <option value="6">6 (High)</option>
                        <% } %>
                    </select>
                </fieldset>
                <fieldset class="form-group">
                    <label for="impact">Impact</label>
                    <select class="form-control" id="impact" name="impact">
                        <% if(ticket.impact == 1 ) { %>
                        <option value="1" selected>1 (Low)</option>
                        <% } else { %>
                        <option value="1">1</option>
                        <% } %>
    
                        <% if(ticket.impact == 2 ) { %>
                        <option value="2" selected>2</option>
                        <% } else { %>
                        <option value="2">2</option>
                        <% } %>
    
                        <% if(ticket.impact == 3 ) { %>
                        <option value="3" selected>3</option>
                        <% } else { %>
                        <option value="3">3</option>
                        <% } %>
    
                        <% if(ticket.impact == 4 ) { %>
                        <option value="4" selected>4</option>
                        <% } else { %>
                        <option value="4">4</option>
                        <% } %>
    
                        <% if(ticket.impact == 5 ) { %>
                        <option value="5" selected>5</option>
                        <% } else { %>
                        <option value="5">5</option>
                        <% } %>
    
                        <% if(ticket.impact == 6 ) { %>
                        <option value="6" selected>6 (High)</option>
                        <% } else { %>
                        <option value="6">6 (High)</option>
                        <% } %>
                    </select>
                </fieldset>
                <fieldset class="form-group">
                    <label for="urgency">Urgency</label>
                    <select class="form-control" id="urgency" name="urgency">
                        <% if(ticket.urgency == 1 ) { %>
                        <option value="1" selected>1 (Low)</option>
                        <% } else { %>
                        <option value="1">1</option>
                        <% } %>
    
                        <% if(ticket.urgency == 2 ) { %>
                        <option value="2" selected>2</option>
                        <% } else { %>
                        <option value="2">2</option>
                        <% } %>
    
                        <% if(ticket.urgency == 3 ) { %>
                        <option value="3" selected>3</option>
                        <% } else { %>
                        <option value="3">3</option>
                        <% } %>
    
                        <% if(ticket.urgency == 4 ) { %>
                        <option value="4" selected>4</option>
                        <% } else { %>
                        <option value="4">4</option>
                        <% } %>
    
                        <% if(ticket.urgency == 5 ) { %>
                        <option value="5" selected>5</option>
                        <% } else { %>
                        <option value="5">5</option>
                        <% } %>
    
                        <% if(ticket.urgency == 6 ) { %>
                        <option value="6" selected>6 (High)</option>
                        <% } else { %>
                        <option value="6">6 (High)</option>
                        <% } %>
                    </select>
                </fieldset>
                <fieldset class="form-group">
                    <label for="resolution">Resolution</label>
                     <textarea class="form-control" id="resolution" name="resolution" placeholder="resolution"><%= ticket.resolution %></textarea>
                </fieldset>
                <fieldset class="form-group">
                    <label for="comment">Narrative Comment</label>
                    <input type="text" class="form-control" id="comment" name="comment" required>
                </fieldset>
                <%
                    var delimiter = '!@#$%';
                        
                    var body = ticket.narrative.body +
                        '(' + ticket.narrative.timeStamp.toLocaleString() + ')' +
                        ' ' + ticket.narrative.username + ' commented: ' +
                        ticket.narrative.comment + delimiter;    
                %>
                <input type="hidden" id="narrativeBody" name="narrativeBody" value="<%= body %>">
                <%if(ticket.status != 'Closed') { %>
                <button type="submit" class="btn btn-primary">Update Ticket</button>
                <% } %>
            </form>
        </div>
    </section>
</div>
<script type="text/javascript">
    //  Bind the event handler to the "submit" JavaScript event
    $('form').submit(function () {

        // Get the stauts and resolution value and trim it
        var status = $.trim($('#status').val());
        var resolution = $.trim($('#resolution').val());
        // Check if empty of not
        if (status === 'Closed') {
            if(resolution === ''){
                alert('To close a ticket you must have a resolution.');
                return false;
            }
        }
    });
</script>
<%- include ../partials/footer.ejs %>
